name: build

on:
  push:
    branches: ["trunk"]
    tags-ignore: ["**"]
    paths-ignore: ["**.md"]
  pull_request: {}
  workflow_dispatch: {}

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: >-
    -Dorg.gradle.jvmargs=-Xmx6g
    -Dorg.gradle.daemon=false
    -Dorg.gradle.vfs.watch=false
    -Dkotlin.incremental=false
    -Dorg.gradle.parallel=true
    -Dorg.gradle.configuration-cache=true

jobs:
  check-no-tests:
    name: Check
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version-file: .github/workflows/.java-version
      - uses: gradle/actions/setup-gradle@v5
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"

      - run: bash ./scripts/enforce_git_lfs.sh

      - run: >
          ./gradlew
          kotlinUpgradeYarnLock
          kotlinWasmUpgradeYarnLock
          check
          -x test
          -x allTests
          -x iosSimulatorArm64Test
          -x iosX64Test
          -x macosX64Test
          -x macosArm64Test
          -x jsBrowserTest
          -x wasmJsBrowserTest
          -x jvmTest

  jvm-tests:
    name: JVM tests
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Java version
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version-file: .github/workflows/.java-version

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"

      - name: Run JVM tests
        run: ./gradlew :liquid:jvmTest

  ios-tests:
    name: iOS tests
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Java version
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version-file: .github/workflows/.java-version

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"

      - name: Run iOS tests
        run: ./gradlew :liquid:iosSimulatorArm64Test

  android-instrumentation-tests:
    name: Android emulator tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        api-level: [ 33, 35 ]

    steps:
      - uses: actions/checkout@v5

      - name: Set up Java version
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version-file: .github/workflows/.java-version

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls /dev/kvm

      - name: Run instrumentation tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: x86_64
          disable-animations: true
          disk-size: 6000M
          heap-size: 600M
          script: ./gradlew connectedDebugAndroidTest --daemon

  screenshot-tests:
    name: Screenshot tests
    runs-on: macos-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v5
        with:
          lfs: true
          ref: ${{ github.head_ref || github.ref }}

      - uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version-file: .github/workflows/.java-version

      - uses: gradle/actions/setup-gradle@v5
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"

      - name: Run Roborazzi screenshot tests
        id: screenshotsverify
        continue-on-error: true
        run: ./gradlew :samples:composeApp:verifyRoborazzi

      - name: Prevent pushing new screenshots if this is a fork
        id: checkfork_screenshots
        continue-on-error: false
        if: steps.screenshotsverify.outcome == 'failure' && github.event.pull_request.head.repo.full_name != github.repository
        run: |
          echo "::error::Screenshot tests failed, please create a PR in your fork first."
          echo "Your fork's CI will take screenshots for your fork."
          exit 1

      - name: Generate new screenshots if verification failed and it's a PR
        id: screenshotsrecord
        if: steps.screenshotsverify.outcome == 'failure' && github.event_name == 'pull_request'
        run: |
          ./gradlew :samples:composeApp:recordRoborazzi

      - name: Push new screenshots if available
        uses: stefanzweifel/git-auto-commit-action@v7
        if: steps.screenshotsrecord.outcome == 'success'
        with:
          file_pattern: '**/screenshots/*.png'
          disable_globbing: true
          commit_message: "ðŸ¤– Updates screenshots"

      - name: Upload screenshot results if failed
        if: ${{ !cancelled() && steps.screenshotsverify.outcome == 'failure' }}
        uses: actions/upload-artifact@v5
        with:
          name: screenshot-test-results
          path: '**/build/outputs/roborazzi/*_compare.png'
          retention-days: 1

  assemble:
    name: Assemble samples
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Java version
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version-file: .github/workflows/.java-version

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"

      - name: Assemble samples
        run: >
          ./gradlew
          kotlinUpgradeYarnLock
          kotlinWasmUpgradeYarnLock
          :samples:composeApp:assembleDebug

  final-status:
    name: Final status check
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    needs: [check-no-tests, jvm-tests, ios-tests, android-instrumentation-tests, screenshot-tests, assemble]
    steps:
      - name: Final status check
        run: |
          results=$(tr -d '\n' <<< '${{ toJSON(needs.*.result) }}')
          if ! grep -q -v -E '(failure|cancelled)' <<< "$results"; then
            echo "One or more required jobs failed"
            exit 1
          fi

  publish:
    name: Publish snapshot
    runs-on: macos-latest
    if: ${{ github.ref == 'refs/heads/trunk' && github.repository == 'fletchmckee/liquid' }}
    needs: [final-status]
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version-file: .github/workflows/.java-version

      - uses: gradle/actions/setup-gradle@v5
        with:
          # TODO: Figure out why this is failing with cache enabled
          cache-disabled: true

      - run: ./gradlew publishToMavenCentral
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_IN_MEMORY_KEY }}

  deploy-docs:
    name: Deploy docs
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: ${{ github.ref == 'refs/heads/trunk' && github.repository == 'fletchmckee/liquid' }}
    needs: [final-status]
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version-file: .github/workflows/.java-version

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Deploy docs
        run: |
          git config user.name 'github-actions[bot]' && git config user.email 'github-actions[bot]@users.noreply.github.com'
          pip3 install --upgrade pip && pip3 install mkdocs-material mkdocs-material-extensions mkdocs-minify-plugin
          bash ./scripts/deploy_docs.sh
